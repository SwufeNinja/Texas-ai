<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>SimpleHoldem AI</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-1: #0b1320;
        --bg-2: #101f2d;
        --accent: #56f2d6;
        --accent-2: #f7c948;
        --ink: #e6edf3;
        --muted: #91a4b7;
        --panel: rgba(16, 26, 38, 0.92);
        --panel-edge: rgba(255, 255, 255, 0.08);
        --good: #3ddc97;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", ui-sans-serif, system-ui, sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 30% 20%, rgba(86, 242, 214, 0.12), transparent 55%),
          radial-gradient(circle at 80% 10%, rgba(247, 201, 72, 0.1), transparent 45%),
          linear-gradient(160deg, #0a1220 0%, #0b1424 40%, #070c16 100%);
        min-height: 100vh;
      }

      .app {
        display: grid;
        grid-template-columns: minmax(280px, 320px) minmax(420px, 1fr) minmax(260px, 360px);
        grid-template-rows: auto auto;
        gap: 24px;
        padding: 32px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-edge);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(12px);
      }

      .title {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(86, 242, 214, 0.12);
        border: 1px solid rgba(86, 242, 214, 0.4);
        color: var(--accent);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .table-area {
        position: relative;
        display: grid;
        gap: 16px;
      }

      .table {
        position: relative;
        min-height: 420px;
        border-radius: 36px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background:
          radial-gradient(circle at 30% 20%, rgba(86, 242, 214, 0.12), transparent 60%),
          radial-gradient(circle at 70% 80%, rgba(247, 201, 72, 0.1), transparent 55%),
          linear-gradient(180deg, rgba(9, 16, 28, 0.9) 0%, rgba(11, 20, 36, 0.96) 100%);
        overflow: hidden;
        box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.6);
      }

      .table::before,
      .table::after {
        content: "";
        position: absolute;
        inset: 12%;
        border-radius: 30px;
        border: 1px dashed rgba(255, 255, 255, 0.08);
      }

      .table::after {
        inset: 24%;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .table-meta {
        display: grid;
        grid-template-columns: repeat(3, auto);
        gap: 16px;
        color: var(--muted);
        font-size: 13px;
      }

      .table-meta span {
        color: var(--ink);
        font-weight: 600;
      }

      .community {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .card {
        width: 56px;
        height: 78px;
        border-radius: 10px;
        background: linear-gradient(160deg, #ffffff 0%, #f0f4f8 100%);
        border: 1px solid rgba(10, 20, 35, 0.18);
        color: #0b1320;
        font-weight: 700;
        display: grid;
        place-items: center;
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
      }

      .card .rank {
        position: absolute;
        top: 6px;
        left: 6px;
        font-size: 14px;
      }

      .card .suit {
        position: absolute;
        bottom: 6px;
        right: 6px;
        font-size: 16px;
      }

      .card.red {
        color: #d6364f;
      }

      .card.empty {
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.4);
        border: 1px dashed rgba(255, 255, 255, 0.18);
      }

      .card.mini {
        width: 34px;
        height: 46px;
        border-radius: 8px;
      }

      .card.mini .rank {
        font-size: 10px;
        top: 4px;
        left: 5px;
      }

      .card.mini .suit {
        font-size: 12px;
        bottom: 4px;
        right: 5px;
      }

      .hand-cards {
        display: flex;
        gap: 6px;
        margin: 6px 0;
      }

      .seats {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .seat {
        position: absolute;
        min-width: 140px;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(10, 18, 30, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
        font-size: 12px;
      }

      .seat.current {
        border-color: rgba(247, 201, 72, 0.6);
        box-shadow: 0 0 0 1px rgba(247, 201, 72, 0.3);
      }

      .seat.active {
        border-color: rgba(61, 220, 151, 0.45);
      }

      .seat .name {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .seat .meta {
        color: var(--muted);
        font-size: 11px;
      }

      .players {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .player {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        padding: 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid transparent;
      }

      .player.active {
        border-color: rgba(61, 220, 151, 0.5);
        background: rgba(61, 220, 151, 0.12);
      }

      .player.current {
        border-color: rgba(247, 201, 72, 0.6);
        box-shadow: 0 0 0 1px rgba(247, 201, 72, 0.3);
      }

      .player .meta {
        font-size: 12px;
        color: var(--muted);
      }

      .ai-remove {
        margin-top: 8px;
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
        color: var(--ink);
        cursor: pointer;
      }

      .ai-remove:hover {
        border-color: rgba(247, 201, 72, 0.6);
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .action-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }

      button {
        font-family: inherit;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
        color: var(--ink);
        cursor: pointer;
        transition: transform 0.2s ease, border 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        border-color: rgba(86, 242, 214, 0.6);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .ready-active {
        border-color: rgba(61, 220, 151, 0.8);
        box-shadow: 0 0 12px rgba(61, 220, 151, 0.6);
        background: rgba(61, 220, 151, 0.18);
      }

      .input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.25);
        color: var(--ink);
      }

      .stack {
        display: grid;
        gap: 12px;
      }

      .action-bar {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: minmax(180px, 240px) 1fr auto;
        gap: 16px;
        align-items: center;
      }

      .action-bar .input {
        max-width: 160px;
      }

      .action-bar .hint {
        text-align: right;
      }

      .log {
        max-height: 300px;
        overflow: auto;
        font-size: 12px;
        color: var(--muted);
        display: grid;
        gap: 6px;
      }

      .players-panel {
        display: grid;
        grid-template-rows: auto 1fr auto 1fr auto 1fr;
        gap: 12px;
        max-height: 720px;
      }

      .players-panel .players {
        margin-top: 0;
        max-height: 360px;
        overflow: auto;
        padding-right: 6px;
      }

      .players-panel .log {
        max-height: 200px;
        overflow: auto;
        padding-right: 6px;
      }

      .detail-line {
        color: rgba(247, 201, 72, 0.85);
        font-size: 11px;
        margin-left: 6px;
      }

      @media (max-width: 980px) {
        .app {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
        }

        .action-bar {
          grid-template-columns: 1fr;
          text-align: left;
        }

        .action-bar .hint {
          text-align: left;
        }

        .table {
          min-height: 320px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="panel">
        <div class="title">Table Control</div>
        <p class="badge" id="connectionStatus">Disconnected</p>
        <div class="stack">
          <label>
            Player ID
            <input class="input" id="playerId" value="p1" />
          </label>
          <label>
            Name
            <input class="input" id="playerName" value="Alice" />
          </label>
          <button id="connectBtn">Connect</button>
          <button id="readyBtn">Ready</button>
          <label>
            AI ID
            <input class="input" id="aiId" value="ai_1" />
          </label>
          <label>
            AI Name
            <input class="input" id="aiName" value="DealerBot" />
          </label>
          <button id="addAiBtn">Add AI</button>
        </div>
      </section>

      <section class="table-area">
        <div class="title">Game State</div>
        <div class="table-meta">
          <div>Stage: <span id="stage">-</span></div>
          <div>Pot: <span id="pot">0</span></div>
          <div>Current: <span id="currentPlayer">-</span></div>
        </div>
        <div class="table">
          <div class="community" id="communityCards"></div>
          <div class="seats" id="seats"></div>
        </div>
      </section>

      <section class="panel players-panel">
        <div class="title">Players</div>
        <div class="players" id="players"></div>
        <div class="title" style="margin-top: 8px;">Waiting</div>
        <div class="players" id="waitingPlayers"></div>
        <div class="title" style="margin-top: 18px;">Log</div>
        <div class="log" id="log"></div>
      </section>

      <section class="panel action-bar">
        <label>
          Raise Amount
          <input class="input" id="raiseAmount" value="10" type="number" min="1" />
        </label>
        <div class="action-row">
          <button data-action="fold">Fold</button>
          <button data-action="check">Check</button>
          <button data-action="call">Call</button>
          <button data-action="raise">Raise</button>
          <button data-action="allin">All-in</button>
        </div>
        <div class="hint" id="actionHint"></div>
      </section>
    </div>

    <script>
      const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws`;
      const connectionStatus = document.getElementById("connectionStatus");
      const connectBtn = document.getElementById("connectBtn");
      const readyBtn = document.getElementById("readyBtn");
      const addAiBtn = document.getElementById("addAiBtn");
      const playerIdInput = document.getElementById("playerId");
      const playerNameInput = document.getElementById("playerName");
      const aiIdInput = document.getElementById("aiId");
      const aiNameInput = document.getElementById("aiName");
      const stageEl = document.getElementById("stage");
      const potEl = document.getElementById("pot");
      const currentPlayerEl = document.getElementById("currentPlayer");
      const communityCardsEl = document.getElementById("communityCards");
      const seatsEl = document.getElementById("seats");
      const playersEl = document.getElementById("players");
      const waitingPlayersEl = document.getElementById("waitingPlayers");
      const logEl = document.getElementById("log");
      const raiseAmountEl = document.getElementById("raiseAmount");
      const actionHintEl = document.getElementById("actionHint");

      let socket = null;
      let lastState = null;

      function log(message) {
        const item = document.createElement("div");
        item.innerHTML = message;
        logEl.prepend(item);
      }

      function updateConnectionUi(connected) {
        connectionStatus.textContent = connected ? "Connected" : "Disconnected";
        connectBtn.textContent = connected ? "Disconnect" : "Connect";
      }

      function connect() {
        if (socket && socket.readyState !== WebSocket.CLOSED) {
          const ok = window.confirm("Are you sure you want to disconnect?");
          if (!ok) {
            return;
          }
          socket.close();
          return;
        }
        const playerId = playerIdInput.value.trim();
        const name = playerNameInput.value.trim();
        if (!playerId) {
          return;
        }
        socket = new WebSocket(wsUrl);
        socket.addEventListener("open", () => {
          socket.send(
            JSON.stringify({
              type: "join",
              data: { player_id: playerId, name },
            })
          );
        });
        socket.addEventListener("message", (event) => {
          const payload = JSON.parse(event.data);
          if (payload.type === "game_update") {
            lastState = payload.data;
            renderState(payload.data);
            updateConnectionUi(true);
          } else if (payload.type === "join_ok") {
            updateConnectionUi(true);
          } else if (payload.type === "error") {
            const details = formatDetails(payload.data.details);
            log(`Error: ${payload.data.message} ${details}`);
          } else if (payload.type === "system") {
            log(`System: ${payload.data.event} ${payload.data.player_id || ""}`.trim());
          }
        });
        socket.addEventListener("close", () => {
          updateConnectionUi(false);
          socket = null;
        });
      }

      function sendAction(action) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          return;
        }
        const amount = action === "raise" ? Number(raiseAmountEl.value || 0) : 0;
        socket.send(
          JSON.stringify({
            type: "action",
            data: { action, amount },
          })
        );
      }

      function renderState(state) {
        stageEl.textContent = state.stage || "-";
        potEl.textContent = state.pot ?? 0;
        currentPlayerEl.textContent = state.current_player_id || "-";
        renderCards(state.community_cards || []);
        renderPlayers(state.players || [], state.current_player_id);
        renderSeats(state.players || [], state.current_player_id);
        refreshButtons();
      }

      function renderCards(cards) {
        communityCardsEl.innerHTML = "";
        const displayCards = cards.length ? cards : ["", "", "", "", ""];
        displayCards.forEach((card) => {
          communityCardsEl.appendChild(createCardElement(card));
        });
      }

      function renderPlayers(players, currentId) {
        playersEl.innerHTML = "";
        waitingPlayersEl.innerHTML = "";
        const canRemoveAi = !isHandInProgress(lastState);
        players.forEach((player) => {
          const row = document.createElement("div");
          const isCurrent = player.id === currentId;
          const isActive = player.status === "PLAYING";
          const readyText = player.ready ? "Ready" : "Not Ready";
          row.className = "player" + (isCurrent ? " current" : "") + (isActive ? " active" : "");
          const left = document.createElement("div");
          const nameLine = document.createElement("div");
          const nameText = document.createElement("span");
          nameText.textContent = player.name;
          const metaText = document.createElement("span");
          metaText.className = "meta";
          metaText.textContent = `(${player.id})`;
          nameLine.appendChild(nameText);
          nameLine.appendChild(document.createTextNode(" "));
          nameLine.appendChild(metaText);

          const handRow = document.createElement("div");
          handRow.className = "hand-cards";
          renderHandCards(handRow, player.hand || []);

          const statusLine = document.createElement("div");
          statusLine.className = "meta";
          statusLine.textContent = player.seated
            ? `${readyText} | Status: ${player.status} | Bet: ${player.bet}`
            : `Spectating | Status: ${player.status}`;

          left.appendChild(nameLine);
          left.appendChild(handRow);
          left.appendChild(statusLine);

          const right = document.createElement("div");
          const chipsLine = document.createElement("div");
          chipsLine.textContent = `${player.chips} chips`;
          right.appendChild(chipsLine);
          if (player.is_ai && canRemoveAi) {
            const removeBtn = document.createElement("button");
            removeBtn.className = "ai-remove";
            removeBtn.textContent = "Remove AI";
            removeBtn.dataset.aiId = player.id;
            right.appendChild(removeBtn);
          }

          row.appendChild(left);
          row.appendChild(right);
          if (player.seated) {
            playersEl.appendChild(row);
          } else {
            waitingPlayersEl.appendChild(row);
          }
        });
      }

      function renderSeats(players, currentId) {
        const seatedPlayers = players.filter((player) => player.seated);
        const positions = [
          { top: "8%", left: "50%", transform: "translate(-50%, -50%)" },
          { top: "20%", left: "85%", transform: "translate(-50%, -50%)" },
          { top: "70%", left: "88%", transform: "translate(-50%, -50%)" },
          { top: "92%", left: "50%", transform: "translate(-50%, -50%)" },
          { top: "70%", left: "12%", transform: "translate(-50%, -50%)" },
          { top: "20%", left: "15%", transform: "translate(-50%, -50%)" },
          { top: "8%", left: "20%", transform: "translate(-50%, -50%)" },
          { top: "8%", left: "80%", transform: "translate(-50%, -50%)" },
        ];
        seatsEl.innerHTML = "";
        seatedPlayers.slice(0, positions.length).forEach((player, index) => {
          const seat = document.createElement("div");
          const isCurrent = player.id === currentId;
          const isActive = player.status === "PLAYING";
          const pos = positions[index % positions.length];
          seat.className = "seat" + (isCurrent ? " current" : "") + (isActive ? " active" : "");
          seat.style.top = pos.top;
          seat.style.left = pos.left;
          seat.style.transform = pos.transform;
          seat.innerHTML = `
            <div class="name">${player.name}</div>
            <div class="meta">(${player.id}) · ${player.chips} chips</div>
            <div class="meta">${player.ready ? "Ready" : "Not Ready"} · ${player.status}</div>
          `;
          seatsEl.appendChild(seat);
        });
      }

      function renderHandCards(container, cards) {
        if (!cards.length) {
          container.appendChild(createCardElement("", true));
          container.appendChild(createCardElement("", true));
          return;
        }
        cards.forEach((card) => {
          container.appendChild(createCardElement(card, true));
        });
      }

      function createCardElement(card, mini) {
        const el = document.createElement("div");
        const isEmpty = !card;
        el.className = "card" + (mini ? " mini" : "") + (isEmpty ? " empty" : "");
        if (isEmpty) {
          el.textContent = "--";
          return el;
        }
        const rank = card.slice(0, 1);
        const suit = card.slice(1, 2);
        const suitInfo = suitSymbol(suit);
        if (suitInfo.isRed) {
          el.classList.add("red");
        }
        const rankEl = document.createElement("span");
        rankEl.className = "rank";
        rankEl.textContent = rank;
        const suitEl = document.createElement("span");
        suitEl.className = "suit";
        suitEl.textContent = suitInfo.symbol;
        el.appendChild(rankEl);
        el.appendChild(suitEl);
        return el;
      }

      function suitSymbol(suit) {
        if (suit === "h") {
          return { symbol: "♥", isRed: true };
        }
        if (suit === "d") {
          return { symbol: "♦", isRed: true };
        }
        if (suit === "c") {
          return { symbol: "♣", isRed: false };
        }
        return { symbol: "♠", isRed: false };
      }

      function isHandInProgress(state) {
        if (!state) {
          return false;
        }
        if (state.stage && state.stage !== "PREFLOP") {
          return true;
        }
        if ((state.pot || 0) > 0) {
          return true;
        }
        return Array.isArray(state.community_cards) && state.community_cards.length > 0;
      }

      function refreshButtons() {
        const buttons = document.querySelectorAll("[data-action]");
        const playerId = playerIdInput.value.trim();
        if (!lastState || !playerId) {
          buttons.forEach((btn) => (btn.disabled = true));
          readyBtn.classList.remove("ready-active");
          readyBtn.disabled = true;
          actionHintEl.textContent = "";
          return;
        }
        const me = (lastState.players || []).find((p) => p.id === playerId);
        const isMyTurn = lastState.current_player_id === playerId;
        const toCall = me ? Math.max(0, lastState.current_bet - me.bet) : 0;
        const bigBlind = Number(lastState.big_blind || 0);
        const lastRaise = Number(lastState.last_raise_size || 0);
        const minRaise = Math.max(bigBlind, lastRaise);
        const maxRaise = me ? Math.max(0, me.chips - toCall) : 0;
        const canAct = Boolean(me && me.status === "PLAYING" && me.ready);
        if (me && me.ready) {
          readyBtn.classList.add("ready-active");
        } else {
          readyBtn.classList.remove("ready-active");
        }
        readyBtn.disabled = !me || !me.seated;
        buttons.forEach((btn) => {
          const action = btn.dataset.action;
          let allowed = isMyTurn && canAct;
          if (action === "check") {
            allowed = allowed && toCall === 0;
          }
          if (action === "call") {
            allowed = allowed && toCall > 0;
          }
          if (action === "raise") {
            allowed = allowed && toCall >= 0;
          }
          btn.disabled = !allowed;
        });

        if (!me) {
          actionHintEl.textContent = "Not seated.";
          return;
        }

        let turnLabel = "Waiting for ready";
        if (me && !me.seated) {
          turnLabel = "Spectating (waiting for a seat)";
        }
        if (canAct) {
          turnLabel = isMyTurn ? "Your turn" : "Waiting for others";
        }
        actionHintEl.textContent =
          `${turnLabel} | To call: ${toCall} | ` +
          `Min raise: ${minRaise} | Max raise: ${maxRaise}`;
      }

      connectBtn.addEventListener("click", connect);
      readyBtn.addEventListener("click", () => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          return;
        }
        socket.send(JSON.stringify({ type: "ready", data: { ready: true } }));
      });
      document.querySelectorAll("[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => sendAction(btn.dataset.action));
      });

      addAiBtn.addEventListener("click", async () => {
        const id = aiIdInput.value.trim();
        const name = aiNameInput.value.trim() || "AI";
        if (!id) {
          return;
        }
        const response = await fetch("/ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ player_id: id, name }),
        });
        const payload = await response.json();
        log(payload.ok ? `AI ${id} added` : `AI add failed: ${payload.message}`);
      });
      playersEl.addEventListener("click", (event) => handleAiRemove(event));
      waitingPlayersEl.addEventListener("click", (event) => handleAiRemove(event));
      function formatDetails(details) {
        const entries = Object.entries(details || {});
        if (!entries.length) {
          return "";
        }
        const items = entries
          .map(([key, value]) => `<span>${key}: ${value}</span>`)
          .join(" · ");
        return `<span class="detail-line">${items}</span>`;
      }

      async function handleAiRemove(event) {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const aiId = target.dataset.aiId;
        if (!aiId) {
          return;
        }
        if (isHandInProgress(lastState)) {
          log("AI remove failed: game already started");
          return;
        }
        const response = await fetch("/ai/remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ player_id: aiId }),
        });
        const payload = await response.json();
        log(payload.ok ? `AI ${aiId} removed` : `AI remove failed: ${payload.message}`);
      }
    </script>
  </body>
</html>
