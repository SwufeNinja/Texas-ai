<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>SimpleHoldem AI</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-1: #0b1320;
        --bg-2: #101f2d;
        --accent: #f7c948;
        --accent-2: #ff6b6b;
        --ink: #e6edf3;
        --muted: #91a4b7;
        --panel: rgba(18, 30, 44, 0.9);
        --panel-edge: rgba(255, 255, 255, 0.08);
        --good: #3ddc97;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", ui-sans-serif, system-ui, sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top, #1a2b3b 0%, var(--bg-1) 45%, #090e18 100%);
        min-height: 100vh;
      }

      .app {
        display: grid;
        grid-template-columns: minmax(280px, 1fr) minmax(320px, 1.2fr) minmax(260px, 1fr);
        gap: 24px;
        padding: 32px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-edge);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(12px);
      }

      .title {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(247, 201, 72, 0.15);
        border: 1px solid rgba(247, 201, 72, 0.4);
        color: var(--accent);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .table {
        position: relative;
        padding: 24px;
        border-radius: 28px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.45) 0%, rgba(16, 31, 45, 0.8) 100%);
        overflow: hidden;
      }

      .table::before,
      .table::after {
        content: "";
        position: absolute;
        inset: 10%;
        border-radius: 28px;
        border: 1px dashed rgba(255, 255, 255, 0.08);
      }

      .table::after {
        inset: 20%;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .community {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 16px;
      }

      .card {
        width: 56px;
        height: 78px;
        border-radius: 10px;
        background: #f4f4f4;
        color: #101f2d;
        font-weight: 700;
        display: grid;
        place-items: center;
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
      }

      .card.empty {
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.4);
      }

      .players {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .player {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        padding: 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid transparent;
      }

      .player.active {
        border-color: rgba(61, 220, 151, 0.5);
        background: rgba(61, 220, 151, 0.12);
      }

      .player.current {
        border-color: rgba(247, 201, 72, 0.6);
        box-shadow: 0 0 0 1px rgba(247, 201, 72, 0.3);
      }

      .player .meta {
        font-size: 12px;
        color: var(--muted);
      }

      .action-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-top: 18px;
      }

      button {
        font-family: inherit;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
        color: var(--ink);
        cursor: pointer;
        transition: transform 0.2s ease, border 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        border-color: rgba(247, 201, 72, 0.6);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .ready-active {
        border-color: rgba(61, 220, 151, 0.8);
        box-shadow: 0 0 12px rgba(61, 220, 151, 0.6);
        background: rgba(61, 220, 151, 0.18);
      }

      .input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.25);
        color: var(--ink);
      }

      .stack {
        display: grid;
        gap: 12px;
      }

      .log {
        max-height: 300px;
        overflow: auto;
        font-size: 12px;
        color: var(--muted);
        display: grid;
        gap: 6px;
      }

      .detail-line {
        color: rgba(247, 201, 72, 0.85);
        font-size: 11px;
        margin-left: 6px;
      }

      @media (max-width: 980px) {
        .app {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="panel">
        <div class="title">Table Control</div>
        <p class="badge" id="connectionStatus">Disconnected</p>
        <div class="stack">
          <label>
            Player ID
            <input class="input" id="playerId" value="p1" />
          </label>
          <label>
            Name
            <input class="input" id="playerName" value="Alice" />
          </label>
          <button id="connectBtn">Connect</button>
          <button id="readyBtn">Ready</button>
          <label>
            AI ID
            <input class="input" id="aiId" value="ai_1" />
          </label>
          <label>
            AI Name
            <input class="input" id="aiName" value="DealerBot" />
          </label>
          <button id="addAiBtn">Add AI</button>
        </div>
        <div class="stack" style="margin-top: 18px;">
          <label>
            Raise Amount
            <input class="input" id="raiseAmount" value="10" type="number" min="1" />
          </label>
          <div class="action-row">
            <button data-action="fold">Fold</button>
            <button data-action="check">Check</button>
            <button data-action="call">Call</button>
            <button data-action="raise">Raise</button>
            <button data-action="allin">All-in</button>
          </div>
        </div>
      </section>

      <section class="panel table">
        <div class="title">Game State</div>
        <div class="stack" style="margin-top: 16px;">
          <div>Stage: <span id="stage">-</span></div>
          <div>Pot: <span id="pot">0</span></div>
          <div>Current: <span id="currentPlayer">-</span></div>
        </div>
        <div class="community" id="communityCards"></div>
      </section>

      <section class="panel">
        <div class="title">Players</div>
        <div class="players" id="players"></div>
        <div class="title" style="margin-top: 18px;">Log</div>
        <div class="log" id="log"></div>
      </section>
    </div>

    <script>
      const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws`;
      const connectionStatus = document.getElementById("connectionStatus");
      const connectBtn = document.getElementById("connectBtn");
      const readyBtn = document.getElementById("readyBtn");
      const addAiBtn = document.getElementById("addAiBtn");
      const playerIdInput = document.getElementById("playerId");
      const playerNameInput = document.getElementById("playerName");
      const aiIdInput = document.getElementById("aiId");
      const aiNameInput = document.getElementById("aiName");
      const stageEl = document.getElementById("stage");
      const potEl = document.getElementById("pot");
      const currentPlayerEl = document.getElementById("currentPlayer");
      const communityCardsEl = document.getElementById("communityCards");
      const playersEl = document.getElementById("players");
      const logEl = document.getElementById("log");
      const raiseAmountEl = document.getElementById("raiseAmount");

      let socket = null;
      let lastState = null;

      function log(message) {
        const item = document.createElement("div");
        item.innerHTML = message;
        logEl.prepend(item);
      }

      function updateConnectionUi(connected) {
        connectionStatus.textContent = connected ? "Connected" : "Disconnected";
        connectBtn.textContent = connected ? "Disconnect" : "Connect";
      }

      function connect() {
        if (socket && socket.readyState !== WebSocket.CLOSED) {
          const ok = window.confirm("Are you sure you want to disconnect?");
          if (!ok) {
            return;
          }
          socket.close();
          return;
        }
        const playerId = playerIdInput.value.trim();
        const name = playerNameInput.value.trim();
        if (!playerId) {
          return;
        }
        socket = new WebSocket(wsUrl);
        socket.addEventListener("open", () => {
          socket.send(
            JSON.stringify({
              type: "join",
              data: { player_id: playerId, name },
            })
          );
        });
        socket.addEventListener("message", (event) => {
          const payload = JSON.parse(event.data);
          if (payload.type === "game_update") {
            lastState = payload.data;
            renderState(payload.data);
            updateConnectionUi(true);
          } else if (payload.type === "join_ok") {
            updateConnectionUi(true);
          } else if (payload.type === "error") {
            const details = formatDetails(payload.data.details);
            log(`Error: ${payload.data.message} ${details}`);
          } else if (payload.type === "system") {
            log(`System: ${payload.data.event} ${payload.data.player_id || ""}`.trim());
          }
        });
        socket.addEventListener("close", () => {
          updateConnectionUi(false);
          socket = null;
        });
      }

      function sendAction(action) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          return;
        }
        const amount = action === "raise" ? Number(raiseAmountEl.value || 0) : 0;
        socket.send(
          JSON.stringify({
            type: "action",
            data: { action, amount },
          })
        );
      }

      function renderState(state) {
        stageEl.textContent = state.stage || "-";
        potEl.textContent = state.pot ?? 0;
        currentPlayerEl.textContent = state.current_player_id || "-";
        renderCards(state.community_cards || []);
        renderPlayers(state.players || [], state.current_player_id);
        refreshButtons();
      }

      function renderCards(cards) {
        communityCardsEl.innerHTML = "";
        const displayCards = cards.length ? cards : ["", "", "", "", ""];
        displayCards.forEach((card) => {
          const el = document.createElement("div");
          el.className = "card" + (card ? "" : " empty");
          el.textContent = card || "--";
          communityCardsEl.appendChild(el);
        });
      }

      function renderPlayers(players, currentId) {
        playersEl.innerHTML = "";
        players.forEach((player) => {
          const row = document.createElement("div");
          const isCurrent = player.id === currentId;
          const isActive = player.status === "PLAYING";
          const handText =
            player.hand && player.hand.length ? `Hand: ${player.hand.join(" ")}` : "";
          const readyText = player.ready ? "Ready" : "Not Ready";
          row.className = "player" + (isCurrent ? " current" : "") + (isActive ? " active" : "");
          row.innerHTML = `
            <div>
              <div>${player.name} <span class="meta">(${player.id})</span></div>
              <div class="meta">${handText ? `${handText} | ` : ""}${readyText} | Status: ${player.status} | Bet: ${player.bet}</div>
            </div>
            <div>
              <div>${player.chips} chips</div>
            </div>
          `;
          playersEl.appendChild(row);
        });
      }

      function refreshButtons() {
        const buttons = document.querySelectorAll("[data-action]");
        const playerId = playerIdInput.value.trim();
        if (!lastState || !playerId) {
          buttons.forEach((btn) => (btn.disabled = true));
          readyBtn.classList.remove("ready-active");
          return;
        }
        const me = (lastState.players || []).find((p) => p.id === playerId);
        const isMyTurn = lastState.current_player_id === playerId;
        const toCall = me ? Math.max(0, lastState.current_bet - me.bet) : 0;
        if (me && me.ready) {
          readyBtn.classList.add("ready-active");
        } else {
          readyBtn.classList.remove("ready-active");
        }
        buttons.forEach((btn) => {
          const action = btn.dataset.action;
          let allowed = isMyTurn;
          if (action === "check") {
            allowed = allowed && toCall === 0;
          }
          if (action === "call") {
            allowed = allowed && toCall > 0;
          }
          if (action === "raise") {
            allowed = allowed && toCall >= 0;
          }
          btn.disabled = !allowed;
        });
      }

      connectBtn.addEventListener("click", connect);
      readyBtn.addEventListener("click", () => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          return;
        }
        socket.send(JSON.stringify({ type: "ready", data: { ready: true } }));
      });
      document.querySelectorAll("[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => sendAction(btn.dataset.action));
      });

      addAiBtn.addEventListener("click", async () => {
        const id = aiIdInput.value.trim();
        const name = aiNameInput.value.trim() || "AI";
        if (!id) {
          return;
        }
        const response = await fetch("/ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ player_id: id, name }),
        });
        const payload = await response.json();
        log(payload.ok ? `AI ${id} added` : `AI add failed: ${payload.message}`);
      });
      function formatDetails(details) {
        const entries = Object.entries(details || {});
        if (!entries.length) {
          return "";
        }
        const items = entries
          .map(([key, value]) => `<span>${key}: ${value}</span>`)
          .join(" Â· ");
        return `<span class="detail-line">${items}</span>`;
      }
    </script>
  </body>
</html>
